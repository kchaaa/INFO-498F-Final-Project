---
title: "Flint Water Crisis"
output: html_document
runtime: shiny
---


```{r, echo=FALSE, message=FALSE, warning=FALSE}
#--------------------------------------------------------------#
# Flint, MI has a water problem. 

# Requires dplyr, library
library(dplyr)
library(knitr)

# Import helper scripts.
source('scripts/help_find.r')
source('scripts/plot.r')
source('scripts/test_results.r')
#--------------------------------------------------------------#
# This dataset only deals with 271 households and contains flushing test data
# Reads in the dataset.
data <- read.csv('data/Flint-Samples-FINAL.csv')
data <- data[-c(91),]

# Renames 3 of the columns to be more readable
colnames(data)[4] <- 'First_Draw'
colnames(data)[5] <- 'Flushing_45_Sec'
colnames(data)[6] <- 'Flushing_2_Min'

#--------------------------------------------------------------#

# This data set contains the amount of ppb of lead and copper for each samples house
flint_data <- read.csv("data/Test_Results_Flint.csv", stringsAsFactors = FALSE)

# Renames 3 of the columns to be more readable
colnames(flint_data)[2] <- 'Date_Submitted'
colnames(flint_data)[4] <- 'Lead_ppb'
colnames(flint_data)[6] <- 'Copper_ppb'

flint_data$Lead_ppb <- as.numeric(gsub(",","", flint_data$Lead_ppb))
flint_data$Copper_ppb <- as.numeric(gsub(",","", flint_data$Copper_ppb))
#--------------------------------------------------------------#

# This section finds the max levels of lead (ppb).

# Obtains the households with the highest level of lead (ppb) from the first sample.
max_first_draw <- data %>% 
                  filter(max(First_Draw) == First_Draw) %>% 
                  select(Ward, First_Draw)

# Obtains the households with the highest level of lead (ppb) from the sample 45 seconds after flushing.
max_45_sec <- data %>% 
              filter(max(Flushing_45_Sec) == Flushing_45_Sec) %>% 
              select(Ward, Flushing_45_Sec)

# Obtains the households with the highest level of lead (ppb) from the sample 2 minutes after flushing.
max_2_min <- data %>% 
             filter(max(Flushing_2_Min) == Flushing_2_Min) %>% 
             select(Ward, Flushing_2_Min)

#--------------------------------------------------------------#
# This section checks which households tested below worrisome level (0-5ppb)

# Obtains the households with ppb levels that are deemed acceptable by the EPA (0-5ppb) for the first sample.
safe_first_draw <- data %>% 
                   filter(First_Draw < 5)

# Counts the number of households that are deemed acceptable by the EPA (0-5ppb) for the first sample.
safe_first_num <- safe_first_draw %>% 
                   group_by(Ward) %>% summarise(First_Draw=sum(Ward==Ward))

# Obtains the households with ppb levels that are deemed acceptable by the EPA (0-5ppb) for the sample 45 seconds after flushing.
safe_45_sec <- data %>% 
               filter(Flushing_45_Sec < 5)

# Counts the number of households that are deemed acceptable by the EPA (0-5ppb) for the sample 45 seconds after flushing.
safe_45sec_num <- safe_45_sec %>% 
                  group_by(Ward) %>% 
                  summarise(Flushing_45_Sec=sum(Ward==Ward))

# Obtains the households with ppb levels that are deemed acceptable by the EPA (0-5ppb) for the sample 2 minutes after flushing.
safe_2_min <- data %>% 
              filter(Flushing_2_Min < 5)

# Counts the number of households that are deemed acceptable by the EPA (0-5ppb) for the sample 2 minutes after flushing.
safe_2min_num <- safe_2_min %>% 
              group_by(Ward) %>% 
              summarise(Flushing_2_Min=sum(Ward==Ward))

# Combines the households that have high ppb levels for all 3 samples.
safe_levels <- inner_join(safe_2_min, safe_45_sec, by = c('SampleID', 'Zip.Code', 'Ward', 'First_Draw', 'Flushing_45_Sec', 'Flushing_2_Min', 'Notes'), copy=FALSE)

safe_levels <- inner_join(safe_levels, safe_first_draw, by = c('SampleID', 'Zip.Code', 'Ward', 'First_Draw', 'Flushing_45_Sec', 'Flushing_2_Min', 'Notes'), copy=FALSE)

# Creates a dataframe that counts the number of houses that are in the safe zone for each sample tests.
safe_num <- left_join(safe_first_num, safe_45sec_num)

safe_num <- left_join(safe_num, safe_2min_num)

safe_num[is.na(safe_num)] <- 0

safe_num <- as.data.frame(safe_num)

#--------------------------------------------------------------#
# This section checks which households contain a relatively safe, but dangerous level of led in the water (5 ppb-15 ppb).

# Obtains the households with ppb levels that are relatively safe, but dangerous level of led in the water (5 ppb-15 ppb) for the first draw samples.
warning_first_draw <- data %>% 
                      filter(First_Draw > 5, First_Draw < 15)

# Counts the number of households 
warning_first_num <- warning_first_draw %>% 
                     group_by(Ward) %>% 
                     summarise(First_Draw=sum(Ward==Ward))

# Obtains the households with ppb levels that are relatively safe, but dangerous level of led in the water (5 ppb-15 ppb) for the samples 45 seconds after flushing.
warning_45_sec <- data %>% 
                  filter(Flushing_45_Sec > 5, Flushing_45_Sec < 15)

# Counts the number of households with ppb levels that are relatively safe, but dangerous level of led in the water (5 ppb-15 ppb) for the samples 45 seconds after flushing.
warning_45sec_num <- warning_45_sec %>% 
                     group_by(Ward) %>% 
                     summarise(Flushing_45_Sec=sum(Ward==Ward))

# Obtains the households with ppb levels that are relatively safe, but dangerous level of led in the water (5 ppb-15 ppb) for the samples 2 minutes after flushing.
warning_2_min <- data %>% 
                 filter(Flushing_2_Min > 5, Flushing_2_Min < 15)

# Counts the number of households with ppb levels that are relatively safe, but dangerous level of led in the water (5 ppb-15 ppb) for the samples 2 minutes after flushing.
warning_2min_num <- warning_2_min %>% 
                    group_by(Ward) %>% 
                    summarise(Flushing_2_Min=sum(Ward==Ward))

# Combines the households that have relatively safe, but dangerous ppb levels for all 3 samples.
warning_levels <- inner_join(warning_2_min, warning_45_sec, by = c('SampleID', 'Zip.Code', 'Ward', 'First_Draw', 'Flushing_45_Sec', 'Flushing_2_Min', 'Notes'), copy=FALSE)

warning_levels <- inner_join(warning_levels, warning_first_draw, by = c('SampleID', 'Zip.Code', 'Ward', 'First_Draw', 'Flushing_45_Sec', 'Flushing_2_Min', 'Notes'), copy=FALSE)

# Creates a dataframe that counts the number of houses that have relatively safe, but still dangerous ppb levels for each sample tests.
warning_num <- left_join(warning_first_num, warning_45sec_num)

warning_num <- left_join(warning_num, warning_2min_num)

warning_num[is.na(warning_num)] <- 0

warning_num <- as.data.frame(warning_num)

#--------------------------------------------------------------#
# This section checks which households tested above the EPA allowed level of led (15ppb). This is when action is necessary.

# Obtains the households with ppb levels above the EPA allowed level (15ppb) for the first sample.
above_epa_first_draw <- data %>% 
                        filter(First_Draw > 15)

# Counts the households with ppb levels above the EPA allowed level (15ppb) for the first sample.
above_first_num <- above_epa_first_draw %>% 
                   group_by(Ward) %>% 
                   summarise(First_Draw=sum(Ward==Ward))

# Obtains the households with ppb levels above the EPA allowed level (15ppb) for the sample 45 seconds after flushing.
above_epa_45_sec <- data %>% 
                    filter(Flushing_45_Sec > 15)

# Counts the households with ppb levels above the EPA allowed level (15ppb) for the first sample.
above_45sec_num <- above_epa_45_sec %>% 
                   group_by(Ward) %>% 
                   summarise(Flushing_45_Sec=sum(Ward==Ward))

# Obtains the households with ppb levels above the EPA allowed level (15ppb) for the sample 2 minutes after flushing.
above_epa_2_min <- data %>% 
                   filter(Flushing_2_Min > 15)

# Counts the households with ppb levels above the EPA allowed level (15ppb) for the first sample.
above_2min_num <- above_epa_2_min %>% 
                  group_by(Ward) %>% 
                  summarise(Flushing_2_Min=sum(Ward==Ward))

# Combines the households that have high ppb levels for all 3 samples.
above_epa <- inner_join(above_epa_2_min, above_epa_45_sec, by = c('SampleID', 'Zip.Code', 'Ward', 'First_Draw', 'Flushing_45_Sec', 'Flushing_2_Min', 'Notes'), copy=FALSE)

above_epa <- inner_join(above_epa, above_epa_first_draw, by = c('SampleID', 'Zip.Code', 'Ward', 'First_Draw', 'Flushing_45_Sec', 'Flushing_2_Min', 'Notes'), copy=FALSE)

# Creates a dataframe that counts the number of houses that have dangerous levels of lead in their water for each sample tests.
above_num <- left_join(above_first_num, above_45sec_num)

above_num  <- left_join(above_num, above_2min_num)

above_num[is.na(above_num)] <- 0

above_num <- as.data.frame(above_num)

#--------------------------------------------------------------#
# This section tallies the numbers to compare.

# Initial number of samples.
num_initial <- nrow(data)

# Number of households with high ppb levels for first sample.
num_first_high_warning <- nrow(warning_first_draw)

# Number of households with standard or lower ppb levels as compared to the high ppb levels for the first sample.
num_first_low_warning<- num_initial - num_first_high_warning

# Number of households with high ppb levels for sample 45 seconds after flushing.
num_45_high_warning <- nrow(warning_45_sec)

# Number of households with high ppb levels for sample 2 minutes after flushing.
num_2_high_warning <- nrow(warning_2_min)

# Number of households that have high ppb levels for all 3 categories.
num_all_high_warning <- nrow(warning_levels)

# Number of households with dangerously high ppb levels for first sample.
num_first_high_danger <- nrow(above_epa_first_draw)

# Number of households with standard or lower ppb levels as compared to the dangerously high ppb levels for the first sample.
num_first_low_danger <- num_initial - num_first_high_danger

# Number of households with dangerously high ppb levels for sample 45 seconds after flushing.
num_45_high_danger <- nrow(above_epa_45_sec)

# Number of households with dangerously high ppb levels for sample 2 minutes after flushing.
num_2_high_danger <- nrow(above_epa_2_min)

# Number of households that have dangerously high ppb levels for all 3 categories.
num_all_high_danger <- nrow(above_epa)

#--------------------------------------------------------------#
# This section finds out which ward has the worst problem

# Which ward has the highest concentration of ppb levels.

# Checks the households in Ward 1
ward_1 <- data %>% 
          filter(Ward == 1)

ward_1_high <- ward_1 %>% 
               filter(First_Draw > 15 | Flushing_45_Sec > 15 | Flushing_2_Min > 15)

num_ward_1 <- nrow(ward_1_high)

# Checks the households in Ward 2
ward_2 <- data %>% 
          filter(Ward == 2)

ward_2_high <- ward_2 %>% 
               filter(First_Draw > 15 | Flushing_45_Sec > 15 | Flushing_2_Min > 15)

num_ward_2 <- nrow(ward_2_high)

# Checks the households in Ward 3
ward_3 <- data %>% 
          filter(Ward == 3)

ward_3_high <- ward_3 %>% 
               filter(First_Draw > 15 | Flushing_45_Sec > 15 | Flushing_2_Min > 15)

num_ward_3 <- nrow(ward_3_high)

# Checks the households in Ward 4
ward_4 <- data %>% 
          filter(Ward == 4)

ward_4_high <- ward_4 %>% 
               filter(First_Draw > 15 | Flushing_45_Sec > 15 | Flushing_2_Min > 15)

num_ward_4 <- nrow(ward_4_high)

# Checks the households in Ward 5
ward_5 <- data %>% 
         filter(Ward == 5)

ward_5_high <- ward_5 %>% 
               filter(First_Draw > 15 | Flushing_45_Sec > 15 | Flushing_2_Min > 15)

num_ward_5 <- nrow(ward_5_high)

# Checks the households in Ward 6
ward_6 <- data %>% 
          filter(Ward == 6)

ward_6_high <- ward_6 %>% 
              filter(First_Draw > 15 | Flushing_45_Sec > 15 | Flushing_2_Min > 15)

num_ward_6 <- nrow(ward_6_high)

# Checks the households in Ward 7
ward_7 <- data %>% 
          filter(Ward == 7)

ward_7_high <- ward_7 %>% 
               filter(First_Draw > 15 | Flushing_45_Sec > 15 | Flushing_2_Min > 15)

num_ward_7 <- nrow(ward_7_high)

# Checks the households in Ward 8
ward_8 <- data %>% 
          filter(Ward == 8)

ward_8_high <- ward_8 %>% 
              filter(First_Draw > 15 | Flushing_45_Sec > 15 | Flushing_2_Min > 15)

num_ward_8 <- nrow(ward_8_high)

# Checks the households in Ward 9
ward_9 <- data %>% 
          filter(Ward == 9)

ward_9_high <- ward_9 %>% 
               filter(First_Draw > 15 | Flushing_45_Sec > 15 | Flushing_2_Min > 15)

num_ward_9 <- nrow(ward_9_high)
```


![Flint Resident Protesting Water Conditions](http://assets.rollingstone.com/assets/2016/article/who-poisoned-flint-michigan-20160122/225359/large_rect/1453440373/1401x788-flint-opener.jpg)


###What is happening in Flint?

In April 2013, the Flint city council voted to join the Karegnondi Water Authority (KWA) that promised that **they would get water from Lake Huron.** This deal will save the city $19 million over eight years instead of continuing to pay Detroit for water. 

In response to Flint's decision, **Detroit announced that they would stop providing Flint water** in April 2014 even though the **KWA won't be ready for another 3 years.** Despite previous concerns about the conditions of the river, the emergency manager in Flint decided that they should **use the Flint River as a backup water source.** After using it, residents begin to **notice and complain about the poor tasting and smelly water.** The city found fecal coliform bacteria and recommended residents filter their water and buy bottled water.

A group of researchers at Virginia Tech eventually decided to study the water and, in September 2015, concluded that it was **"creating a public health threat."** The river water, they found, was more corrosive than Lake Huron's water, which **damaged older pipes and allowed iron and lead to enter the city's water supply.**

The water change is also a possible cause of an **outbreak of Legionnaires' disease** in the county that has **killed 10 people and affected another 77.**

###How Did the Government Respond?

On January 16, 2016, President Obama signed an emergency declaration ordering federal assistance to support state and local response efforts in Flint, Michigan. The U.S. Department of Health and Human Services (HHS) has been designated the lead federal agency responsible for coordinating federal government response and recovery efforts.

The government of Michigan and Flint worked to try to fix the water source; however, the state government refused to allow Flint to switch their water supply back to Detroit. Due to the government's effort, the city finally was able to improve the quality fo their water. 

Their celebration would be short because scientists soon found lead in the water due to old pipes and poor infrastructure. 

The State government promised to use $1 million to buy water filters for the city of Flint and finally allowed Flint to use Detroit water again. The government recommended they boil water as a way to clean their water, but boiling water results in higher lead concentration because a heavy metal like lead doesn't evaporate like water does. 

###What Are the Effects of Consuming Lead-Infected Water?

The lead-infected water has serious health effects on the residents of Flint especially the children and pregnant women of Flint. There are medications that would reduce the amount of lead in their blood to reduce the negative effects of lead; however, no medication exist to treat for the adverse health effects. 

####Children
* Behavior and learning problems
* Lower IQ and hyperactivity
* Slowed growth
* Hearing problems Anemia

####Pregnant Women
* Reduced growth of the fetus
* Premature Birth

####Adults
* Cardiovascular effects, increased blood pressure and incidence of hypertension
* Decreased kidney function
* Reproductive problems (in both men and women)

###How is the Test Conducted?

A few months ago, a test was done in Flint. Three tests were conducted using the residents' toilets: 

1) the first draw, 

2) 45 seconds after flushing,  

3) 2 minutes after flushing. 

###What Do the Results of the Tests Mean?

**0 ppb:** no lead detected in the drinking water

**1-4 ppb:** the EPA deems this range as acceptable

**5-14 ppb:** exposure is a concern, but still below an EPA “federal action level”

**15-49 ppb:** a range above the federal action level for lead, but can be treated by filters

**50-149 ppb:** reaching dangerous levels, but can be treated by filters

**150 and above:** a range at which the federal government says water filters might not work

###What is ppb?

Ppb stands for Parts Per Billion. It is the unit used to measure how much lead is in the water.

###What is a Ward?
A ward is a district or section of a city. As we can see in the grpahic above, there are a total of 9 wards in Flint, MI. 

###Which Ward is in the Most Danger? Least Danger?

###What Does This Graphic Show?
We will compare the number of households that reported acceptable levels of lead, realitvely safe levels of lead, and dangerous levels of lead.


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(shiny)
library(plotly)
# The names function finds the column names to be used in shiny interactions
names <- colnames(safe_num[2:4])
# Indicates the beginning of the shiny architecture
shinyApp(
  # Ui Section
  ui = fluidPage(
    titlePanel("Number of Houses per Contamination levels"),
    sidebarLayout(
      sidebarPanel(
        selectInput("choice", label = h3("Test Type"),
                    choices = names, selected = "First_Ward_Num")
      ),
      # Outputs the bar chart in mainPanel
      mainPanel(
        plotlyOutput("bar")
      )
    )
  ),
  # Server Section
  server = function(input, output) {
    # Sends plotly graph to ui to be printed
    output$bar <- renderPlotly({
      # Uses a functioni from plot.r to generate a graph
      stackbar(safe_num, warning_num, above_num, input$choice)
    })
  },
  # Changes the size of the graph to optimmize its use in the rmd
  options = list(height = 463)
  )
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Implements the line graph for shiny
shinyApp(
  ui = fluidPage(
    titlePanel("Number of Contaminated House by Danger Level per Month"),
      mainPanel(
        plotlyOutput("barstack")
      )
    ),
  #--
  server = function(input, output) {
    output$barstack <- renderPlotly({
      month_bar(total)
    })
  },
  options = list(height = 463)
)
```



```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Implements the line graph for shiny
shinyApp(
  ui = fluidPage(
    titlePanel("Average Lead ppb per Month"),
      mainPanel(
        plotlyOutput("bar")
      )
    ),
  #--
  server = function(input, output) {
    output$bar <- renderPlotly({
      month_line(avg_sep, avg_oct, avg_nov, avg_dec, avg_jan, avg_feb, avg_mar)
    })
  },
  options = list(height = 463)
)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)

shinyApp(
ui = fluidPage(
  sidebarLayout(
    sidebarPanel(
      h4("Relief Stations")),
      mainPanel(
        plotOutput("plot1")
      )
  )
  ),
  server = function(input, output) {
    output$plot1 <- renderPlot({
      p <- get_filter_map
      print(p)
    })
    
    output$Hover_Info <- renderPrint({
      cat("input$plot_hover:\n")
      str(input$plot_hover)
    })
  },
  options = list(height = 463)
)

```